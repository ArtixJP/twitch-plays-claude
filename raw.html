<!DOCTYPE html>

<html lang="en">
<head>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https:; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://unpkg.com https://esm.sh https://esm.run https://cdn.tailwindcss.com https://threejs.org https://cdn.threejs.org https://cdn.p5js.org https://code.jquery.com https://d3js.org https://cdn.plot.ly https://cdn.tonejs.org; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://fonts.gstatic.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net; img-src 'self' data: https:; media-src 'self' https:; font-src 'self' https://fonts.gstatic.com https://fonts.googleapis.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net; worker-src 'self'; frame-src https://www.youtube.com https://www.youtube-nocookie.com https://player.vimeo.com; connect-src 'self' https: wss: ws:; object-src 'none'; base-uri 'self'; form-action 'self';">
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Homer in Springfield! üç©‚öõÔ∏è</title>
<style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
        font-family: system-ui, sans-serif; 
        display: flex; 
        flex-direction: column;
        justify-content: center; 
        align-items: center; 
        min-height: 100vh; 
        background: linear-gradient(135deg, #0a1628 0%, #1e3a5f 50%, #2563eb 100%);
        color: white;
        overflow: hidden;
    }
    #gameContainer {
        position: relative;
        width: 900px;
        height: 500px;
        border: 4px solid #3b82f6;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 0 50px rgba(59, 130, 246, 0.5);
    }
    #gameCanvas {
        display: block;
        background: linear-gradient(180deg, #FFE135 0%, #87CEEB 40%, #90EE90 70%, #228B22 100%);
    }
    .game-title {
        font-size: 2.5rem;
        text-align: center;
        margin-bottom: 15px;
        text-shadow: 3px 3px 0 #3b82f6, 6px 6px 0 rgba(0,0,0,0.3);
        animation: title-bounce 1s ease-in-out infinite;
    }
    @keyframes title-bounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-5px); }
    }
    .controls-panel {
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(0, 0, 0, 0.8);
        border: 2px solid #60a5fa;
        border-radius: 12px;
        padding: 15px;
        width: 200px;
        z-index: 100;
    }
    .controls-panel h3 {
        color: #60a5fa;
        font-size: 1rem;
        margin-bottom: 10px;
        text-align: center;
        border-bottom: 1px solid rgba(96, 165, 250, 0.3);
        padding-bottom: 8px;
    }
    .control-item {
        display: flex;
        align-items: center;
        margin: 8px 0;
        font-size: 0.85rem;
    }
    .control-key {
        background: linear-gradient(145deg, #3b82f6, #2563eb);
        color: white;
        padding: 4px 10px;
        border-radius: 5px;
        font-weight: bold;
        margin-right: 10px;
        min-width: 60px;
        text-align: center;
        box-shadow: 0 3px 0 #1d4ed8;
    }
    .score-display {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(0, 0, 0, 0.7);
        padding: 10px 20px;
        border-radius: 10px;
        border: 2px solid #60a5fa;
        font-size: 1.2rem;
    }
    .score-display span {
        color: #ffd700;
        font-weight: bold;
    }
    .chat-commands {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(0, 0, 0, 0.8);
        border: 2px solid #bf94ff;
        border-radius: 12px;
        padding: 15px;
        width: 220px;
        max-height: 300px;
        overflow-y: auto;
        z-index: 100;
    }
    .chat-commands h4 {
        color: #bf94ff;
        margin-bottom: 10px;
        text-align: center;
        font-size: 0.9rem;
    }
    .chat-cmd {
        padding: 5px 8px;
        margin: 4px 0;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 5px;
        font-size: 0.75rem;
        animation: cmd-flash 0.3s ease;
    }
    .chat-cmd .user { color: #ffd700; font-weight: bold; }
    .chat-cmd .action { color: #90EE90; }
    @keyframes cmd-flash {
        0% { background: rgba(255, 215, 0, 0.5); }
        100% { background: rgba(255, 255, 255, 0.1); }
    }
    @keyframes syncPulse {
        0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
        50% { transform: translate(-50%, -50%) scale(1.05); }
        100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }
    @keyframes pulse {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.8; transform: scale(1.02); }
    }
    .game-info {
        margin-top: 15px;
        text-align: center;
        color: #a0aec0;
        font-size: 0.9rem;
    }
    .game-info code {
        background: rgba(145, 71, 255, 0.2);
        padding: 2px 8px;
        border-radius: 4px;
        color: #bf94ff;
    }
</style>
</head>
<body>
<h1 class="game-title">üç© Homer in Springfield! ‚öõÔ∏èüíô</h1>
<div id="gameContainer">
<canvas height="500" id="gameCanvas" width="900"></canvas>
<div class="score-display">üç© Donuts: <span id="score">0</span> <span style="color:#8B4513;font-size:0.8em;">üç´+25!</span></div>
</div>
<div class="controls-panel">
<h3>üéÆ Chat Controls</h3>
<div class="control-item"><span class="control-key">UP</span> Jump!</div>
<div class="control-item"><span class="control-key">LEFT</span> Go left</div>
<div class="control-item"><span class="control-key">RIGHT</span> Go right</div>
<div style="margin-top:15px;font-size:0.75rem;color:#90EE90;text-align:center;font-weight:bold;">üéÆ 100% CHAT CONTROLLED!<br/>Take your time! üåø<br/>‚¨ÜÔ∏è Type UP/LEFT/RIGHT ‚¨ÜÔ∏è</div>
</div>
<div class="chat-commands">
<h4>üí¨ Recent Commands</h4>
<div id="commandLog"></div>
</div>
<p class="game-info">
    Type <code>UP</code>, <code>LEFT</code>, or <code>RIGHT</code> in Twitch chat to control Homer!<br/>
    üö´ No keyboard ‚Ä¢ No auto-play ‚Ä¢ <span style="color:#ffd700;font-weight:bold;">CHAT ONLY!</span> üç©<br/>
<span style="color:#90EE90;font-size:0.8rem;">üîÑ Homer syncs with recent commands on page load! D'OH!</span>
</p>
<script>
// Game Setup
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const scoreEl = document.getElementById('score');
const commandLog = document.getElementById('commandLog');

// Game State
let score = 0;
let gameTime = 0;

// Homer Simpson!
const mario = {
    x: 100,
    y: 350,
    width: 40,
    height: 50,
    vx: 0,
    vy: 0,
    onGround: false,
    direction: 1,
    frame: 0
};

// Physics
const GRAVITY = 0.6;
const JUMP_FORCE = -14;
const MOVE_SPEED = 6;
const FRICTION = 0.85;
const GROUND_Y = 400;

// Platforms
const platforms = [
    { x: 0, y: GROUND_Y, width: 900, height: 100 },
    { x: 150, y: 320, width: 120, height: 20 },
    { x: 350, y: 260, width: 150, height: 20 },
    { x: 550, y: 320, width: 120, height: 20 },
    { x: 700, y: 220, width: 100, height: 20 },
    { x: 50, y: 180, width: 100, height: 20 },
    { x: 250, y: 140, width: 80, height: 20 }
];

// Collectibles (donuts - Homer's favorite!)
let croissants = [];

// Chocolate donuts - bonus collectibles!
let chocolateDonuts = [];

function spawnChocolateDonut() {
    const plat = platforms[Math.floor(Math.random() * (platforms.length - 1)) + 1];
    chocolateDonuts.push({
        x: plat.x + Math.random() * (plat.width - 30),
        y: plat.y - 35,
        collected: false,
        wobble: Math.random() * Math.PI * 2
    });
}

// Mystery Block (fireworks!)
const mysteryBlock = {
    x: 380,
    y: 260,
    width: 40,
    height: 40,
    active: true,
    hitCooldown: 0
};

// Fireworks particles
let fireworks = [];

function createFirework(x, y) {
    const colors = ['#ff0000', '#ffd700', '#00ff00', '#00bfff', '#ff69b4', '#ff8c00', '#9400d3'];
    for (let i = 0; i < 50; i++) {
        const angle = (Math.PI * 2 / 50) * i + Math.random() * 0.5;
        const speed = 3 + Math.random() * 5;
        fireworks.push({
            x: x,
            y: y,
            vx: Math.cos(angle) * speed,
            vy: Math.sin(angle) * speed,
            color: colors[Math.floor(Math.random() * colors.length)],
            life: 60 + Math.random() * 40,
            size: 3 + Math.random() * 4
        });
    }
    // Add sparkle burst
    for (let i = 0; i < 20; i++) {
        fireworks.push({
            x: x,
            y: y,
            vx: (Math.random() - 0.5) * 10,
            vy: (Math.random() - 0.5) * 10,
            color: '#ffffff',
            life: 30 + Math.random() * 20,
            size: 2
        });
    }
}

function updateFireworks() {
    fireworks = fireworks.filter(p => {
        p.x += p.vx;
        p.y += p.vy;
        p.vy += 0.15; // gravity
        p.life--;
        p.size *= 0.98;
        return p.life > 0 && p.size > 0.5;
    });
}

function drawFireworks() {
    fireworks.forEach(p => {
        ctx.globalAlpha = p.life / 60;
        ctx.fillStyle = p.color;
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
        ctx.fill();
        // Trail effect
        ctx.fillStyle = p.color;
        ctx.globalAlpha = p.life / 120;
        ctx.beginPath();
        ctx.arc(p.x - p.vx, p.y - p.vy, p.size * 0.7, 0, Math.PI * 2);
        ctx.fill();
    });
    ctx.globalAlpha = 1;
}
function spawnCroissant() {
    const plat = platforms[Math.floor(Math.random() * (platforms.length - 1)) + 1];
    croissants.push({
        x: plat.x + Math.random() * (plat.width - 30),
        y: plat.y - 35,
        collected: false
    });
}

// Obstacles removed by community - Mario roams free! üåø

// Initial spawns
for (let i = 0; i < 5; i++) spawnCroissant();
for (let i = 0; i < 3; i++) spawnChocolateDonut();

// Springfield Nuclear Power Plant background position
const powerPlant = { x: 720, y: 120 };

// Command queue from chat
let commandQueue = [];
let lastCommands = [];

// Load saved commands from localStorage
let savedCommandsForReplay = [];
try {
    const savedCommands = localStorage.getItem('marioParisCommands');
    if (savedCommands) {
        lastCommands = JSON.parse(savedCommands);
        savedCommandsForReplay = [...lastCommands].reverse(); // Reverse to get oldest first for replay
        console.log('üìÇ Loaded', lastCommands.length, 'commands from localStorage');
    }
} catch (e) {
    console.log('Could not load saved commands');
}

// Process chat messages for commands
function processCommand(username, message) {
    const msg = message.toUpperCase().trim();
    let action = null;
    
    if (msg.includes('UP') || msg.includes('JUMP') || msg.includes('SAUT')) {
        action = 'JUMP';
        commandQueue.push({ type: 'jump' });
    }
    if (msg.includes('LEFT') || msg.includes('GAUCHE')) {
        action = 'LEFT';
        commandQueue.push({ type: 'left' });
    }
    if (msg.includes('RIGHT') || msg.includes('DROITE')) {
        action = 'RIGHT';
        commandQueue.push({ type: 'right' });
    }
    
    if (action) {
        lastCommands.unshift({ user: username, action: action });
        if (lastCommands.length > 8) lastCommands.pop();
        updateCommandLog();
    }
}

function updateCommandLog() {
    commandLog.innerHTML = lastCommands.map(c => 
        `<div class="chat-cmd"><span class="user">${c.user}:</span> <span class="action">${c.action}</span></div>`
    ).join('');
    
    // Save commands to localStorage for persistence
    try {
        localStorage.setItem('marioParisCommands', JSON.stringify(lastCommands));
    } catch (e) {
        console.log('Could not save commands');
    }
}

// Chat integration
let initialSyncDone = false;
let syncMessageShown = false;

function showSyncMessage(count) {
    if (syncMessageShown) return;
    syncMessageShown = true;
    const syncDiv = document.createElement('div');
    syncDiv.id = 'syncNotification';
    syncDiv.style.cssText = 'position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.9);color:#ffd700;padding:20px 40px;border-radius:15px;border:3px solid #ffd700;font-size:1.2rem;text-align:center;z-index:1000;animation:syncPulse 0.5s ease;';
    syncDiv.innerHTML = `üîÑ Syncing with <span style="color:#90EE90;font-weight:bold;">${count}</span> recent commands...`;
    document.getElementById('gameContainer').appendChild(syncDiv);
    
    setTimeout(() => {
        syncDiv.innerHTML = `‚úÖ Mario synced! <span style="color:#90EE90;">Ready to play!</span>`;
        syncDiv.style.borderColor = '#90EE90';
        setTimeout(() => syncDiv.remove(), 1500);
    }, 800);
}

function initChatControls() {
    if (window.tpc) {
        // Process existing messages - apply them rapidly on first load!
        if (window.tpc.chatMessages && !initialSyncDone) {
            initialSyncDone = true;
            
            // Filter only command messages
            const allMessages = window.tpc.chatMessages;
            const commandMessages = allMessages.filter(m => {
                const msg = m.message.toUpperCase();
                return msg.includes('UP') || msg.includes('JUMP') || msg.includes('SAUT') ||
                       msg.includes('LEFT') || msg.includes('GAUCHE') ||
                       msg.includes('RIGHT') || msg.includes('DROITE');
            });
            
            // Get last 10 command messages for sync (oldest first for proper replay)
            const recentCommands = commandMessages.slice(-10);
            
            console.log('üîÑ Syncing Mario with last', recentCommands.length, 'commands (oldest‚Üínewest) from', allMessages.length, 'total messages...');
            
            if (recentCommands.length > 0) {
                showSyncMessage(recentCommands.length);
                console.log('üéÆ Replaying', recentCommands.length, 'commands oldest‚Üínewest for sync...');
            }
            
            // First, populate the command log with the commands (BEFORE physics sync)
            const displayCommands = recentCommands.slice(-8); // Show last 8 in log
            displayCommands.forEach(m => {
                const msg = m.message.toUpperCase().trim();
                let action = null;
                if (msg.includes('UP') || msg.includes('JUMP') || msg.includes('SAUT')) action = 'JUMP';
                else if (msg.includes('LEFT') || msg.includes('GAUCHE')) action = 'LEFT';
                else if (msg.includes('RIGHT') || msg.includes('DROITE')) action = 'RIGHT';
                
                if (action) {
                    lastCommands.push({ user: m.username, action: action });
                }
            });
            // Reverse to show newest first, then trim to 8
            lastCommands = lastCommands.slice(-8).reverse();
            updateCommandLog();
            console.log('üìã Command log populated with', lastCommands.length, 'commands');
            
            // Execute commands in order with VISIBLE animation: oldest first (index 0 = oldest)
            console.log('üìú Executing commands in order (oldest ‚Üí newest) with animation:');
            
            // Queue commands for animated replay
            window.syncCommandQueue = recentCommands.map((m, index) => {
                const msg = m.message.toUpperCase().trim();
                let action = 'UNKNOWN';
                if (msg.includes('UP') || msg.includes('JUMP') || msg.includes('SAUT')) action = 'JUMP';
                else if (msg.includes('LEFT') || msg.includes('GAUCHE')) action = 'LEFT';
                else if (msg.includes('RIGHT') || msg.includes('DROITE')) action = 'RIGHT';
                return { username: m.username, action: action, index: index };
            }).filter(c => c.action !== 'UNKNOWN');
            
            window.syncIndex = 0;
            window.syncActive = true;
            window.syncFrameCount = 0;
            
            console.log('üé¨ Starting animated sync with', window.syncCommandQueue.length, 'commands...');
            
            // Clamp Mario to screen bounds after sync
            if (mario.x < 0) mario.x = 50;
            if (mario.x > canvas.width - mario.width) mario.x = canvas.width - mario.width - 50;
            if (mario.y > GROUND_Y - mario.height) mario.y = GROUND_Y - mario.height;
            
            console.log('‚úÖ Mario synced! Position:', mario.x.toFixed(0), mario.y.toFixed(0));
        }
        // Listen for new messages
        window.tpc.onChatMessage = (msg) => {
            processCommand(msg.username, msg.message);
        };
        console.log('Chat controls connected!');
    }
}

// Initialize command log from localStorage on page load
if (lastCommands.length > 0) {
    updateCommandLog();
}

// Try to connect to chat
initChatControls();

// Fallback: If no tpc available after 500ms, replay from localStorage
setTimeout(() => {
    if (!initialSyncDone && savedCommandsForReplay.length > 0) {
        console.log('üîÑ No Twitch chat detected, replaying from localStorage...');
        initialSyncDone = true;
        showSyncMessage(savedCommandsForReplay.length);
        
        // Queue commands for animated replay from localStorage
        window.syncCommandQueue = savedCommandsForReplay.map((cmd, index) => ({
            username: cmd.user,
            action: cmd.action,
            index: index
        }));
        
        window.syncIndex = 0;
        window.syncActive = true;
        window.syncFrameCount = 0;
        
        console.log('üé¨ Starting localStorage sync with', window.syncCommandQueue.length, 'commands...');
    }
}, 500);

setInterval(() => {
    if (!window.tpc) return;
    if (!window.tpc.onChatMessage) initChatControls();
}, 1000);

// Process command queue
function processCommands() {
    // Handle animated sync replay first
    if (window.syncActive && window.syncCommandQueue && window.syncCommandQueue.length > 0) {
        window.syncFrameCount++;
        
        // Execute a command every 20 frames (visible movement)
        if (window.syncFrameCount % 20 === 0 && window.syncIndex < window.syncCommandQueue.length) {
            const syncCmd = window.syncCommandQueue[window.syncIndex];
            console.log(`üéÆ Sync ${window.syncIndex + 1}/${window.syncCommandQueue.length}: [${syncCmd.username}] ${syncCmd.action}`);
            
            // Show floating text for the command
            showSyncCommand(syncCmd.username, syncCmd.action);
            
            if (syncCmd.action === 'JUMP' || syncCmd.action === 'UP') {
                if (mario.onGround) {
                    mario.vy = JUMP_FORCE;
                    mario.onGround = false;
                }
            }
            if (syncCmd.action === 'LEFT') {
                mario.vx = -MOVE_SPEED * 1.5;
                mario.direction = -1;
            }
            if (syncCmd.action === 'RIGHT') {
                mario.vx = MOVE_SPEED * 1.5;
                mario.direction = 1;
            }
            
            window.syncIndex++;
            
            if (window.syncIndex >= window.syncCommandQueue.length) {
                window.syncActive = false;
                console.log('‚úÖ Sync animation complete! Mario is now at:', mario.x.toFixed(0), mario.y.toFixed(0));
            }
        }
        return; // Don't process regular commands during sync
    }
    
    while (commandQueue.length > 0) {
        const cmd = commandQueue.shift();
        if (cmd.type === 'jump' && mario.onGround) {
            mario.vy = JUMP_FORCE;
            mario.onGround = false;
        }
        if (cmd.type === 'left') {
            mario.vx = -MOVE_SPEED;
            mario.direction = -1;
        }
        if (cmd.type === 'right') {
            mario.vx = MOVE_SPEED;
            mario.direction = 1;
        }
    }
}

// Floating command indicator during sync
let syncFloaters = [];
function showSyncCommand(username, action) {
    const emoji = action === 'JUMP' ? '‚¨ÜÔ∏è' : action === 'LEFT' ? '‚¨ÖÔ∏è' : '‚û°Ô∏è';
    syncFloaters.push({
        x: mario.x + mario.width/2,
        y: mario.y - 20,
        text: `${emoji} ${username}`,
        life: 60,
        vy: -1
    });
}

function updateSyncFloaters() {
    syncFloaters = syncFloaters.filter(f => {
        f.y += f.vy;
        f.life--;
        return f.life > 0;
    });
}

function drawSyncFloaters() {
    ctx.font = 'bold 14px Arial';
    ctx.textAlign = 'center';
    syncFloaters.forEach(f => {
        ctx.globalAlpha = f.life / 60;
        ctx.fillStyle = '#ffd700';
        ctx.fillText(f.text, f.x, f.y);
    });
    ctx.globalAlpha = 1;
    ctx.textAlign = 'left';
    
    // Draw sync progress bar if active
    if (window.syncActive && window.syncCommandQueue) {
        const progress = window.syncIndex / window.syncCommandQueue.length;
        ctx.fillStyle = 'rgba(0,0,0,0.7)';
        ctx.fillRect(canvas.width/2 - 100, 10, 200, 25);
        ctx.fillStyle = '#ffd700';
        ctx.fillRect(canvas.width/2 - 98, 12, 196 * progress, 21);
        ctx.fillStyle = '#fff';
        ctx.font = 'bold 12px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(`üîÑ Syncing: ${window.syncIndex}/${window.syncCommandQueue.length}`, canvas.width/2, 27);
        ctx.textAlign = 'left';
    }
}

// PEACEFUL MODE - Mario moves at his own pace!
// No pressure, no rushing, just chill vibes üåø
function showWaitingMessage() {
    // Removed hint timer - let players take their time!
}

// Physics update
function updatePhysics() {
    // Apply gravity
    mario.vy += GRAVITY;
    
    // Apply friction
    mario.vx *= FRICTION;
    
    // Update position
    mario.x += mario.vx;
    mario.y += mario.vy;
    
    // Platform collision
    mario.onGround = false;
    for (const plat of platforms) {
        if (mario.x + mario.width > plat.x && 
            mario.x < plat.x + plat.width &&
            mario.y + mario.height > plat.y &&
            mario.y + mario.height < plat.y + plat.height + mario.vy + 5) {
            mario.y = plat.y - mario.height;
            mario.vy = 0;
            mario.onGround = true;
        }
    }
    
    // Screen bounds
    if (mario.x < 0) mario.x = 0;
    if (mario.x > canvas.width - mario.width) mario.x = canvas.width - mario.width;
    if (mario.y > canvas.height) {
        mario.y = 100;
        mario.vy = 0;
    }
    
    // Mystery block collision (hit from below!)
    if (mysteryBlock.hitCooldown > 0) mysteryBlock.hitCooldown--;
    if (mysteryBlock.active && mysteryBlock.hitCooldown === 0 &&
        mario.x + mario.width > mysteryBlock.x && mario.x < mysteryBlock.x + mysteryBlock.width &&
        mario.y < mysteryBlock.y + mysteryBlock.height && mario.y > mysteryBlock.y &&
        mario.vy < 0) {
        // Hit the block from below!
        mario.vy = 2; // Bounce down
        createFirework(mysteryBlock.x + mysteryBlock.width/2, mysteryBlock.y - 50);
        createFirework(mysteryBlock.x + mysteryBlock.width/2 - 30, mysteryBlock.y - 80);
        createFirework(mysteryBlock.x + mysteryBlock.width/2 + 30, mysteryBlock.y - 80);
        score += 50;
        scoreEl.textContent = score;
        mysteryBlock.hitCooldown = 120; // 2 second cooldown
    }
    
    // Collect croissants
    croissants.forEach((c, i) => {
        if (!c.collected &&
            mario.x < c.x + 30 && mario.x + mario.width > c.x &&
            mario.y < c.y + 30 && mario.y + mario.height > c.y) {
            c.collected = true;
            score += 10;
            scoreEl.textContent = score;
            setTimeout(() => {
                croissants.splice(i, 1);
                spawnCroissant();
            }, 100);
        }
    });
    
    // Collect chocolate donuts (bonus points!)
    chocolateDonuts.forEach((c, i) => {
        if (!c.collected &&
            mario.x < c.x + 30 && mario.x + mario.width > c.x &&
            mario.y < c.y + 30 && mario.y + mario.height > c.y) {
            c.collected = true;
            score += 25; // Chocolate is worth more!
            scoreEl.textContent = score;
            // Chocolate sparkle effect
            for (let j = 0; j < 10; j++) {
                fireworks.push({
                    x: c.x + 15,
                    y: c.y + 15,
                    vx: (Math.random() - 0.5) * 6,
                    vy: (Math.random() - 0.5) * 6,
                    color: ['#8B4513', '#D2691E', '#A0522D'][Math.floor(Math.random() * 3)],
                    life: 30,
                    size: 4
                });
            }
            setTimeout(() => {
                chocolateDonuts.splice(i, 1);
                spawnChocolateDonut();
            }, 100);
        }
    });
    
    // No obstacles - pure exploration mode! üéÆ
}

// Drawing
function drawBackground() {
    // Sky gradient
    const skyGrad = ctx.createLinearGradient(0, 0, 0, GROUND_Y);
    skyGrad.addColorStop(0, '#1e40af');
    skyGrad.addColorStop(1, '#60a5fa');
    ctx.fillStyle = skyGrad;
    ctx.fillRect(0, 0, canvas.width, GROUND_Y);
    
    // Clouds
    ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
    ctx.beginPath();
    ctx.arc(100 + Math.sin(gameTime * 0.01) * 20, 80, 30, 0, Math.PI * 2);
    ctx.arc(130 + Math.sin(gameTime * 0.01) * 20, 70, 40, 0, Math.PI * 2);
    ctx.arc(160 + Math.sin(gameTime * 0.01) * 20, 80, 30, 0, Math.PI * 2);
    ctx.fill();
    
    ctx.beginPath();
    ctx.arc(500 + Math.sin(gameTime * 0.008) * 30, 60, 25, 0, Math.PI * 2);
    ctx.arc(530 + Math.sin(gameTime * 0.008) * 30, 50, 35, 0, Math.PI * 2);
    ctx.arc(560 + Math.sin(gameTime * 0.008) * 30, 60, 25, 0, Math.PI * 2);
    ctx.fill();
    
    // Eiffel Tower (background)
    // Draw Nuclear Power Plant cooling towers
    ctx.fillStyle = '#808080';
    // Left tower
    ctx.beginPath();
    ctx.moveTo(powerPlant.x, powerPlant.y + 180);
    ctx.lineTo(powerPlant.x + 20, powerPlant.y);
    ctx.lineTo(powerPlant.x + 60, powerPlant.y);
    ctx.lineTo(powerPlant.x + 80, powerPlant.y + 180);
    ctx.fill();
    // Right tower
    ctx.beginPath();
    ctx.moveTo(powerPlant.x + 90, powerPlant.y + 180);
    ctx.lineTo(powerPlant.x + 110, powerPlant.y + 20);
    ctx.lineTo(powerPlant.x + 150, powerPlant.y + 20);
    ctx.lineTo(powerPlant.x + 170, powerPlant.y + 180);
    ctx.fill();
    // Radioactive glow
    ctx.fillStyle = '#39FF14';
    ctx.globalAlpha = 0.5 + Math.sin(gameTime * 0.1) * 0.3;
    ctx.beginPath();
    ctx.arc(powerPlant.x + 40, powerPlant.y - 10, 15, 0, Math.PI * 2);
    ctx.arc(powerPlant.x + 130, powerPlant.y + 10, 12, 0, Math.PI * 2);
    ctx.fill();
    ctx.globalAlpha = 1;
    // ‚öõÔ∏è symbol
    ctx.font = '40px Arial';
    ctx.fillText('‚öõÔ∏è', powerPlant.x + 60, powerPlant.y + 100);
    
    // Chocolate factory in background
    ctx.fillStyle = '#5D3A1A';
    ctx.fillRect(50, 280, 80, 120);
    ctx.fillStyle = '#8B4513';
    ctx.fillRect(55, 260, 70, 25);
    // Chocolate smoke
    ctx.fillStyle = 'rgba(139, 69, 19, 0.4)';
    ctx.beginPath();
    ctx.arc(90 + Math.sin(gameTime * 0.05) * 10, 240 + Math.cos(gameTime * 0.03) * 5, 20, 0, Math.PI * 2);
    ctx.arc(85 + Math.sin(gameTime * 0.04) * 8, 220 + Math.cos(gameTime * 0.05) * 5, 15, 0, Math.PI * 2);
    ctx.fill();
    // Sign
    ctx.fillStyle = '#FFD700';
    ctx.font = 'bold 10px Arial';
    ctx.fillText('üç´ CHOCO', 55, 310);
}

function drawMysteryBlock() {
    const b = mysteryBlock;
    const bounce = mysteryBlock.hitCooldown > 100 ? Math.sin(mysteryBlock.hitCooldown * 0.5) * 5 : 0;
    
    // Block shadow
    ctx.fillStyle = 'rgba(0,0,0,0.3)';
    ctx.fillRect(b.x + 4, b.y + 4 - bounce, b.width, b.height);
    
    // Main block (golden)
    const goldGrad = ctx.createLinearGradient(b.x, b.y - bounce, b.x, b.y + b.height - bounce);
    if (mysteryBlock.hitCooldown > 0) {
        goldGrad.addColorStop(0, '#888');
        goldGrad.addColorStop(0.5, '#666');
        goldGrad.addColorStop(1, '#444');
    } else {
        goldGrad.addColorStop(0, '#ffd700');
        goldGrad.addColorStop(0.5, '#ffed4a');
        goldGrad.addColorStop(1, '#f59e0b');
    }
    ctx.fillStyle = goldGrad;
    ctx.fillRect(b.x, b.y - bounce, b.width, b.height);
    
    // Border
    ctx.strokeStyle = mysteryBlock.hitCooldown > 0 ? '#555' : '#b45309';
    ctx.lineWidth = 3;
    ctx.strokeRect(b.x, b.y - bounce, b.width, b.height);
    
    // Question mark
    ctx.fillStyle = mysteryBlock.hitCooldown > 0 ? '#444' : '#7c2d12';
    ctx.font = 'bold 28px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('?', b.x + b.width/2, b.y + b.height - 10 - bounce);
    ctx.textAlign = 'left';
    
    // Sparkle effect when active
    if (mysteryBlock.hitCooldown === 0 && gameTime % 30 < 15) {
        ctx.fillStyle = '#fff';
        ctx.beginPath();
        ctx.arc(b.x + 8, b.y + 8, 3, 0, Math.PI * 2);
        ctx.fill();
    }
}

function drawPlatforms() {
    platforms.forEach((plat, i) => {
        if (i === 0) {
            // Ground - grass
            ctx.fillStyle = '#228B22';
            ctx.fillRect(plat.x, plat.y, plat.width, 20);
            ctx.fillStyle = '#8B4513';
            ctx.fillRect(plat.x, plat.y + 20, plat.width, plat.height - 20);
        } else {
            // Floating platforms - brick style
            ctx.fillStyle = '#CD853F';
            ctx.fillRect(plat.x, plat.y, plat.width, plat.height);
            ctx.strokeStyle = '#8B4513';
            ctx.lineWidth = 2;
            ctx.strokeRect(plat.x, plat.y, plat.width, plat.height);
            
            // Brick lines
            ctx.strokeStyle = '#A0522D';
            for (let bx = plat.x + 20; bx < plat.x + plat.width; bx += 20) {
                ctx.beginPath();
                ctx.moveTo(bx, plat.y);
                ctx.lineTo(bx, plat.y + plat.height);
                ctx.stroke();
            }
        }
    });
}

function drawMario() {
    ctx.save();
    ctx.translate(mario.x + mario.width / 2, mario.y + mario.height / 2);
    ctx.scale(mario.direction, 1);
    
    // Homer's Body (white shirt)
    ctx.fillStyle = '#FFFFFF';
    ctx.fillRect(-18, -5, 36, 30);
    
    // Homer's big belly bulge
    ctx.fillStyle = '#FFFFFF';
    ctx.beginPath();
    ctx.ellipse(0, 15, 20, 15, 0, 0, Math.PI * 2);
    ctx.fill();
    
    // Homer's Head (yellow Simpson skin!)
    ctx.fillStyle = '#FFD90F';
    ctx.beginPath();
    ctx.ellipse(0, -18, 18, 20, 0, 0, Math.PI * 2);
    ctx.fill();
    
    // Homer's signature hair strands (just 2!)
    ctx.strokeStyle = '#000';
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(-5, -38);
    ctx.quadraticCurveTo(-3, -42, 0, -38);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(3, -38);
    ctx.quadraticCurveTo(6, -43, 8, -38);
    ctx.stroke();
    
    // Homer's ear
    ctx.fillStyle = '#FFD90F';
    ctx.beginPath();
    ctx.ellipse(16, -15, 5, 7, 0, 0, Math.PI * 2);
    ctx.fill();
    
    // Homer's 5 o'clock shadow
    ctx.fillStyle = 'rgba(100, 100, 100, 0.3)';
    ctx.beginPath();
    ctx.ellipse(0, -2, 12, 8, 0, 0, Math.PI);
    ctx.fill();
    
    // Homer's big round eyes
    ctx.fillStyle = '#FFFFFF';
    ctx.beginPath();
    ctx.arc(-6, -20, 8, 0, Math.PI * 2);
    ctx.arc(6, -20, 8, 0, Math.PI * 2);
    ctx.fill();
    ctx.fillStyle = '#000';
    ctx.beginPath();
    ctx.arc(-6, -19, 3, 0, Math.PI * 2);
    ctx.arc(6, -19, 3, 0, Math.PI * 2);
    ctx.fill();
    
    // Homer's nose
    ctx.fillStyle = '#FFD90F';
    ctx.beginPath();
    ctx.ellipse(0, -12, 6, 5, 0, 0, Math.PI * 2);
    ctx.fill();
    
    // Homer's mouth (open, drooling for donuts)
    ctx.fillStyle = '#8B4513';
    ctx.beginPath();
    ctx.ellipse(0, -3, 8, 4, 0, 0, Math.PI);
    ctx.fill();
    
    // Blue pants
    const legOffset = mario.onGround ? Math.sin(gameTime * 0.3) * 5 : 5;
    ctx.fillStyle = '#2E5090';
    ctx.fillRect(-15, 25, 14, 18);
    ctx.fillRect(1 + legOffset, 25, 14, 18);
    
    // Gray shoes
    ctx.fillStyle = '#555555';
    ctx.fillRect(-17, 40, 16, 6);
    ctx.fillRect(legOffset - 1, 40, 16, 6);
    
    ctx.restore();
}

function drawCroissants() {
    ctx.font = '35px Arial';
    croissants.forEach(c => {
        if (!c.collected) {
            // Pink frosted donut with sprinkles!
            ctx.fillText('üç©', c.x, c.y + 28);
        }
    });
}

function drawChocolateDonuts() {
    chocolateDonuts.forEach(c => {
        if (!c.collected) {
            c.wobble += 0.1;
            const wobbleY = Math.sin(c.wobble) * 3;
            
            // Draw chocolate donut (brown with chocolate drizzle)
            ctx.save();
            ctx.translate(c.x + 15, c.y + 15 + wobbleY);
            
            // Outer ring (chocolate)
            ctx.fillStyle = '#4a2c2a';
            ctx.beginPath();
            ctx.arc(0, 0, 15, 0, Math.PI * 2);
            ctx.fill();
            
            // Inner hole
            ctx.fillStyle = '#87CEEB';
            ctx.beginPath();
            ctx.arc(0, 0, 5, 0, Math.PI * 2);
            ctx.fill();
            
            // Chocolate frosting
            ctx.fillStyle = '#8B4513';
            ctx.beginPath();
            ctx.arc(0, -2, 12, Math.PI, Math.PI * 2);
            ctx.fill();
            
            // Chocolate drizzle lines
            ctx.strokeStyle = '#3d1f1f';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(-8, -5);
            ctx.quadraticCurveTo(-4, 0, 0, -3);
            ctx.quadraticCurveTo(4, -6, 8, -2);
            ctx.stroke();
            
            // Sparkle
            if (gameTime % 40 < 20) {
                ctx.fillStyle = '#fff';
                ctx.beginPath();
                ctx.arc(-5, -8, 2, 0, Math.PI * 2);
                ctx.fill();
            }
            
            ctx.restore();
            
            // +25 label
            ctx.fillStyle = '#8B4513';
            ctx.font = 'bold 10px Arial';
            ctx.fillText('+25', c.x + 5, c.y - 5 + wobbleY);
        }
    });
}

// Baguettes function removed - peaceful Paris! üóº

// Game loop
function gameLoop() {
    gameTime++;
    
    // Process chat commands
    processCommands();
    
    // Show waiting hint if no commands for a while
    showWaitingMessage();
    
    // Baguettes disabled by community request - peaceful mode! üåø
    
    // Update physics
    updatePhysics();
    
    // Clear and draw
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    drawBackground();
    drawPlatforms();
    drawCroissants();
    drawChocolateDonuts();
    // Baguettes removed - no more obstacles! üéÆ
    drawMario();
    drawMysteryBlock();
    updateFireworks();
    drawFireworks();
    
    updateSyncFloaters();
    drawSyncFloaters();
    
    requestAnimationFrame(gameLoop);
}

// Start game
gameLoop();

// KEYBOARD CONTROLS DISABLED BY COMMUNITY REQUEST
// Mario is now 100% controlled by Twitch chat!
// Type UP, LEFT, or RIGHT in chat to play!
console.log('üç© Mmm... donuts! üç´ Chocolate donuts worth +25! Chat-only mode active!');
</script>
</body>
</html>