<!DOCTYPE html>

<html lang="en">
<head>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https:; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://unpkg.com https://esm.sh https://esm.run https://cdn.tailwindcss.com https://threejs.org https://cdn.threejs.org https://cdn.p5js.org https://code.jquery.com https://d3js.org https://cdn.plot.ly https://cdn.tonejs.org; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://fonts.gstatic.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net; img-src 'self' data: https:; media-src 'self' https:; font-src 'self' https://fonts.gstatic.com https://fonts.googleapis.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net; worker-src 'self'; frame-src https://www.youtube.com https://www.youtube-nocookie.com https://player.vimeo.com; connect-src 'self' https: wss: ws:; object-src 'none'; base-uri 'self'; form-action 'self';">
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Simpsons 3D Opening</title>
<style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { overflow: hidden; background: #000; }
        #scene-container { width: 100vw; height: 100vh; }
        #episode-counter {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: #FFD700;
            padding: 10px 20px;
            border-radius: 10px;
            font-family: 'Arial Black', sans-serif;
            font-size: 1rem;
            z-index: 300;
        }
        #gag-text {
            position: absolute;
            bottom: 10%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.5rem;
            color: white;
            text-shadow: 2px 2px 4px black;
            text-align: center;
            opacity: 0;
            z-index: 200;
            font-family: 'Arial Black', sans-serif;
            transition: opacity 0.5s;
        }
        .instruction {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: #a0aec0;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.9rem;
            z-index: 300;
            font-family: Arial, sans-serif;
        }
        .instruction code {
            background: rgba(145, 71, 255, 0.2);
            padding: 2px 8px;
            border-radius: 4px;
            color: #bf94ff;
        }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #FFD700;
            font-family: 'Arial Black', sans-serif;
            font-size: 2rem;
            z-index: 400;
        }
    </style>
</head>
<body>
<div id="scene-container"></div>
<div id="episode-counter">Episode: <span id="ep-num">1</span></div>
<div id="gag-text"></div>
<p class="instruction">Type <code>!idea your idea</code> in chat to modify the show!</p>
<div id="loading">Loading 3D Springfield...</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
        // Audio setup
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        const melody = [
            {note: 'C5', duration: 0.3}, {note: 'E5', duration: 0.3}, {note: 'F#5', duration: 0.3}, {note: 'A5', duration: 0.3},
            {note: 'G5', duration: 0.6}, {note: 'E5', duration: 0.3}, {note: 'C5', duration: 0.3},
            {note: 'A4', duration: 0.4}, {note: 'F#4', duration: 0.4}, {note: 'F#4', duration: 0.4}, {note: 'F#4', duration: 0.2},
            {note: 'G4', duration: 0.8}
        ];
        
        const noteFreqs = {
            'C4': 261.63, 'D4': 293.66, 'E4': 329.63, 'F4': 349.23, 'F#4': 369.99, 'G4': 392.00, 'A4': 440.00,
            'C5': 523.25, 'E5': 659.25, 'F#5': 739.99, 'G5': 783.99, 'A5': 880.00
        };
        
        function playNote(freq, startTime, duration) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'square';
            osc.frequency.value = freq;
            gain.gain.setValueAtTime(0.12, startTime);
            gain.gain.exponentialRampToValueAtTime(0.01, startTime + duration);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start(startTime);
            osc.stop(startTime + duration);
        }
        
        function playTheme() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            let time = audioCtx.currentTime;
            melody.forEach(({note, duration}) => {
                if (noteFreqs[note]) playNote(noteFreqs[note], time, duration * 0.9);
                time += duration * 0.5;
            });
        }
        
        // Three.js setup
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setClearColor(0x87CEEB);
        document.getElementById('scene-container').appendChild(renderer.domElement);
        
        // Lighting
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(5, 10, 7);
        scene.add(directionalLight);
        
        // Materials
        const yellowMat = new THREE.MeshLambertMaterial({ color: 0xFFD700 });
        const whiteMat = new THREE.MeshLambertMaterial({ color: 0xffffff });
        const blueMat = new THREE.MeshLambertMaterial({ color: 0x4169E1 });
        const greenMat = new THREE.MeshLambertMaterial({ color: 0x32CD32 });
        const orangeMat = new THREE.MeshLambertMaterial({ color: 0xFF6600 });
        const redMat = new THREE.MeshLambertMaterial({ color: 0xFF0000 });
        const babyBlueMat = new THREE.MeshLambertMaterial({ color: 0x87CEEB });
        const couchMat = new THREE.MeshLambertMaterial({ color: 0x8B0000 });
        const floorMat = new THREE.MeshLambertMaterial({ color: 0x228B22 });
        const wallMat = new THREE.MeshLambertMaterial({ color: 0x8B4513 });
        const cloudMat = new THREE.MeshLambertMaterial({ color: 0xffffff, transparent: true, opacity: 0.9 });
        
        // Create clouds
        const clouds = [];
        function createCloud(x, y, z) {
            const cloud = new THREE.Group();
            for (let i = 0; i < 5; i++) {
                const sphere = new THREE.Mesh(
                    new THREE.SphereGeometry(1 + Math.random(), 16, 16),
                    cloudMat
                );
                sphere.position.set(Math.random() * 2 - 1, Math.random() * 0.5, Math.random() * 2 - 1);
                cloud.add(sphere);
            }
            cloud.position.set(x, y, z);
            cloud.userData = { speed: 0.01 + Math.random() * 0.02 };
            scene.add(cloud);
            clouds.push(cloud);
        }
        
        for (let i = 0; i < 20; i++) {
            createCloud(
                Math.random() * 60 - 30,
                5 + Math.random() * 10,
                Math.random() * 40 - 50
            );
        }
        
        // Create 3D Title
        const titleGroup = new THREE.Group();
        const titleGeo = new THREE.BoxGeometry(12, 2, 0.5);
        const titleMesh = new THREE.Mesh(titleGeo, yellowMat);
        titleGroup.add(titleMesh);
        
        // Add "THE SIMPSONS" text using boxes
        const letters = 'THE SIMPSONS';
        for (let i = 0; i < letters.length; i++) {
            if (letters[i] !== ' ') {
                const letterBox = new THREE.Mesh(
                    new THREE.BoxGeometry(0.6, 0.8, 0.3),
                    new THREE.MeshLambertMaterial({ color: 0x8B4513 })
                );
                letterBox.position.set(-5 + i * 0.85, 0, 0.4);
                titleGroup.add(letterBox);
            }
        }
        titleGroup.position.set(0, 20, -30);
        scene.add(titleGroup);
        
        // Create character function
        function createCharacter(bodyColor, headHeight = 0.5, bodyHeight = 0.6, scale = 1) {
            const character = new THREE.Group();
            
            // Head
            const head = new THREE.Mesh(new THREE.SphereGeometry(0.4 * scale, 16, 16), yellowMat);
            head.position.y = bodyHeight + 0.4 * scale;
            character.add(head);
            
            // Body
            const body = new THREE.Mesh(
                new THREE.CylinderGeometry(0.25 * scale, 0.3 * scale, bodyHeight, 16),
                bodyColor
            );
            body.position.y = bodyHeight / 2;
            character.add(body);
            
            // Legs
            const legGeo = new THREE.CylinderGeometry(0.08 * scale, 0.1 * scale, 0.4 * scale, 8);
            const leftLeg = new THREE.Mesh(legGeo, blueMat);
            leftLeg.position.set(-0.12 * scale, -0.2 * scale, 0);
            character.add(leftLeg);
            
            const rightLeg = new THREE.Mesh(legGeo, blueMat);
            rightLeg.position.set(0.12 * scale, -0.2 * scale, 0);
            character.add(rightLeg);
            
            return character;
        }
        
        // Create family
        const homer = createCharacter(whiteMat, 0.5, 0.7, 1.1);
        const marge = createCharacter(greenMat, 0.5, 0.6, 1);
        // Add Marge's hair
        const margeHair = new THREE.Mesh(
            new THREE.CylinderGeometry(0.25, 0.35, 1.2, 16),
            blueMat
        );
        margeHair.position.y = 1.8;
        marge.add(margeHair);
        
        const bart = createCharacter(orangeMat, 0.4, 0.5, 0.8);
        // Bart's spiky hair
        for (let i = 0; i < 5; i++) {
            const spike = new THREE.Mesh(
                new THREE.ConeGeometry(0.08, 0.3, 8),
                yellowMat
            );
            spike.position.set(Math.cos(i * 1.2) * 0.2, 1.1, Math.sin(i * 1.2) * 0.1);
            bart.add(spike);
        }
        
        const lisa = createCharacter(redMat, 0.35, 0.4, 0.7);
        // Lisa's star hair
        for (let i = 0; i < 8; i++) {
            const spike = new THREE.Mesh(
                new THREE.ConeGeometry(0.06, 0.25, 8),
                yellowMat
            );
            spike.position.set(Math.cos(i * 0.8) * 0.18, 0.9, Math.sin(i * 0.8) * 0.15);
            lisa.add(spike);
        }
        
        const maggie = createCharacter(babyBlueMat, 0.3, 0.3, 0.5);
        
        const family = [homer, marge, bart, lisa, maggie];
        family.forEach(char => {
            char.position.set(20, 0, 0);
            char.visible = false;
            scene.add(char);
        });
        
        // Living room
        const livingRoom = new THREE.Group();
        
        // Floor
        const floor = new THREE.Mesh(
            new THREE.PlaneGeometry(20, 15),
            floorMat
        );
        floor.rotation.x = -Math.PI / 2;
        floor.position.y = -0.5;
        livingRoom.add(floor);
        
        // Back wall
        const backWall = new THREE.Mesh(
            new THREE.PlaneGeometry(20, 10),
            wallMat
        );
        backWall.position.set(0, 4.5, -7);
        livingRoom.add(backWall);
        
        // Couch
        const couch = new THREE.Group();
        const couchBase = new THREE.Mesh(
            new THREE.BoxGeometry(5, 1, 1.5),
            couchMat
        );
        couchBase.position.y = 0;
        couch.add(couchBase);
        
        const couchBack = new THREE.Mesh(
            new THREE.BoxGeometry(5, 1.5, 0.3),
            couchMat
        );
        couchBack.position.set(0, 0.75, -0.6);
        couch.add(couchBack);
        
        couch.position.set(0, 0, 0);
        livingRoom.add(couch);
        
        // TV
        const tv = new THREE.Group();
        const tvBody = new THREE.Mesh(
            new THREE.BoxGeometry(1.5, 1.2, 0.5),
            new THREE.MeshLambertMaterial({ color: 0x333333 })
        );
        tv.add(tvBody);
        
        const tvScreen = new THREE.Mesh(
            new THREE.PlaneGeometry(1.2, 0.9),
            new THREE.MeshBasicMaterial({ color: 0x4169E1 })
        );
        tvScreen.position.z = 0.26;
        tv.add(tvScreen);
        
        tv.position.set(4, 0.6, -5);
        livingRoom.add(tv);
        
        livingRoom.position.set(0, 0, 50);
        livingRoom.visible = false;
        scene.add(livingRoom);
        
        // Grass ground
        const grassGround = new THREE.Mesh(
            new THREE.PlaneGeometry(100, 100),
            floorMat
        );
        grassGround.rotation.x = -Math.PI / 2;
        grassGround.position.y = -1;
        scene.add(grassGround);
        
        // Camera initial position
        camera.position.set(0, 5, 15);
        camera.lookAt(0, 5, 0);
        
        // Animation state
        let phase = 'clouds';
        let animationTime = 0;
        let episodeCount = 0;
        
        const couchGags = [
            { text: "The family sits normally... in 3D!", action: 'normal' },
            { text: "Homer bounces off the couch!", action: 'bounce' },
            { text: "The couch spins!", action: 'spin' },
            { text: "Everyone is tiny!", action: 'tiny' },
            { text: "Zero gravity!", action: 'gravity' },
            { text: "The family orbits the couch!", action: 'orbit' },
            { text: "Couch explosion!", action: 'explode' },
            { text: "Matrix slow-mo!", action: 'matrix' }
        ];
        
        let currentGag = couchGags[0];
        let gagStartTime = 0;
        
        function startEpisode() {
            episodeCount++;
            document.getElementById('ep-num').textContent = episodeCount;
            document.getElementById('gag-text').style.opacity = '0';
            
            phase = 'clouds';
            animationTime = 0;
            
            // Reset title
            titleGroup.position.set(0, 20, -30);
            titleGroup.rotation.set(0, 0, 0);
            
            // Reset family
            family.forEach((char, i) => {
                char.position.set(20 + i * 2, 0, 0);
                char.rotation.set(0, 0, 0);
                char.scale.set(1, 1, 1);
                char.visible = false;
            });
            
            // Reset couch
            couch.position.set(0, 0, 0);
            couch.rotation.set(0, 0, 0);
            couch.scale.set(1, 1, 1);
            
            livingRoom.visible = false;
            grassGround.visible = true;
            
            // Reset camera
            camera.position.set(0, 5, 15);
            camera.lookAt(0, 5, 0);
            
            currentGag = couchGags[Math.floor(Math.random() * couchGags.length)];
            
            playTheme();
        }
        
        function animate() {
            requestAnimationFrame(animate);
            animationTime += 0.016;
            
            // Animate clouds
            clouds.forEach(cloud => {
                cloud.position.x -= cloud.userData.speed;
                if (cloud.position.x < -35) cloud.position.x = 35;
            });
            
            // Phase-based animation
            if (phase === 'clouds') {
                // Title flies through clouds
                titleGroup.position.z += 0.3;
                titleGroup.position.y = 8 + Math.sin(animationTime * 2) * 0.5;
                titleGroup.rotation.y = Math.sin(animationTime) * 0.1;
                
                camera.position.z = 15 + animationTime * 2;
                camera.lookAt(titleGroup.position);
                
                if (animationTime > 3) {
                    phase = 'running';
                    animationTime = 0;
                    family.forEach(char => char.visible = true);
                }
            } else if (phase === 'running') {
                // Family runs across screen
                family.forEach((char, i) => {
                    char.position.x = 15 - animationTime * 8 + i * 1.5;
                    char.position.y = Math.abs(Math.sin(animationTime * 10 + i)) * 0.3;
                    char.rotation.y = -Math.PI / 2;
                });
                
                camera.position.set(0, 3, 10);
                camera.lookAt(family[2].position);
                
                if (animationTime > 4) {
                    phase = 'livingroom';
                    animationTime = 0;
                    livingRoom.visible = true;
                    grassGround.visible = false;
                    gagStartTime = 0;
                }
            } else if (phase === 'livingroom') {
                // Living room scene
                camera.position.set(0, 4, 58);
                camera.lookAt(0, 1, 50);
                
                // Family enters and sits
                if (animationTime < 2) {
                    family.forEach((char, i) => {
                        const targetX = -2 + i * 1;
                        const targetZ = 50.5;
                        char.position.x += (targetX - char.position.x) * 0.05;
                        char.position.z += (targetZ - char.position.z) * 0.05;
                        char.position.y = 0.5 + Math.abs(Math.sin(animationTime * 8 + i)) * 0.2;
                        char.rotation.y = 0;
                    });
                } else {
                    // Apply couch gag
                    gagStartTime += 0.016;
                    document.getElementById('gag-text').textContent = currentGag.text;
                    document.getElementById('gag-text').style.opacity = '1';
                    
                    applyGag(currentGag.action, gagStartTime);
                }
                
                if (animationTime > 7) {
                    startEpisode();
                }
            }
            
            renderer.render(scene, camera);
        }
        
        function applyGag(action, time) {
            switch(action) {
                case 'bounce':
                    homer.position.y = 0.5 + Math.abs(Math.sin(time * 5)) * 3;
                    break;
                case 'spin':
                    couch.rotation.y = time * 3;
                    family.forEach((char, i) => {
                        char.position.x = Math.cos(time * 3 + i * 0.5) * 2.5;
                        char.position.z = 50 + Math.sin(time * 3 + i * 0.5) * 2.5;
                    });
                    break;
                case 'tiny':
                    family.forEach(char => char.scale.setScalar(0.3));
                    break;
                case 'gravity':
                    family.forEach((char, i) => {
                        char.position.y = 3 + Math.sin(time * 2 + i) * 1;
                        char.rotation.z = time;
                    });
                    break;
                case 'orbit':
                    family.forEach((char, i) => {
                        const angle = time * 2 + (i / 5) * Math.PI * 2;
                        char.position.x = Math.cos(angle) * 3;
                        char.position.z = 50 + Math.sin(angle) * 3;
                        char.position.y = 1 + Math.sin(time * 3) * 0.5;
                    });
                    break;
                case 'explode':
                    family.forEach((char, i) => {
                        char.position.x = Math.cos(i * 1.2) * time * 2;
                        char.position.z = 50 + Math.sin(i * 1.2) * time * 2;
                        char.position.y = time * 2;
                        char.rotation.x = time * 3;
                        char.rotation.z = time * 2;
                    });
                    break;
                case 'matrix':
                    camera.position.x = Math.cos(time * 0.5) * 8;
                    camera.position.z = 58 + Math.sin(time * 0.5) * 5;
                    camera.lookAt(0, 1, 50);
                    break;
                default:
                    family.forEach((char, i) => {
                        char.position.set(-2 + i * 1, 0.5, 50.5);
                    });
            }
        }
        
        // Handle resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
        
        // Start
        document.getElementById('loading').style.display = 'none';
        animate();
        setTimeout(startEpisode, 1000);
    </script>
</body>
</html>