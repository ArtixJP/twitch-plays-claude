<!DOCTYPE html>

<html lang="en">
<head>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https:; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://unpkg.com https://esm.sh https://esm.run https://cdn.tailwindcss.com https://threejs.org https://cdn.threejs.org https://cdn.p5js.org https://code.jquery.com https://d3js.org https://cdn.plot.ly https://cdn.tonejs.org; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://fonts.gstatic.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net; img-src 'self' data: https:; media-src 'self' https:; font-src 'self' https://fonts.gstatic.com https://fonts.googleapis.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net; worker-src 'self'; frame-src https://www.youtube.com https://www.youtube-nocookie.com https://player.vimeo.com; connect-src 'self' https: wss: ws:; object-src 'none'; base-uri 'self'; form-action 'self';">
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Twitch Plays Pokemon</title>
<style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Press Start 2P', system-ui, monospace; 
            display: flex; 
            flex-direction: column;
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            overflow: hidden;
        }
        #game-container {
            position: relative;
            border: 4px solid #bf94ff;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(145, 71, 255, 0.5);
        }
        #gameCanvas {
            display: block;
            background: #3d8b40;
            image-rendering: pixelated;
        }
        #ui {
            position: absolute;
            top: 8px;
            left: 8px;
            background: rgba(0,0,0,0.7);
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 10px;
        }
        #controls {
            margin-top: 10px;
            font-size: 9px;
            color: #a0aec0;
            text-align: center;
        }
        #battle-ui {
            display: none;
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.9);
            padding: 10px;
            border-top: 3px solid #bf94ff;
        }
        #battle-ui.active { display: block; }
        .battle-options {
            display: flex;
            gap: 10px;
            justify-content: center;
            font-size: 11px;
        }
        .battle-btn {
            background: #bf94ff;
            color: #1a1a2e;
            border: none;
            padding: 8px 16px;
            cursor: pointer;
            font-family: inherit;
            font-size: 10px;
        }
        .battle-btn:hover { background: #9147ff; }
        #message {
            text-align: center;
            margin-bottom: 8px;
            font-size: 11px;
            min-height: 16px;
        }
        .monster-display {
            display: flex;
            justify-content: space-around;
            margin-bottom: 10px;
        }
        .monster-card {
            text-align: center;
            font-size: 9px;
        }
        .hp-bar {
            width: 80px;
            height: 8px;
            background: #333;
            border-radius: 4px;
            overflow: hidden;
            margin: 4px auto;
        }
        .hp-fill {
            height: 100%;
            background: #4ade80;
            transition: width 0.3s;
        }
        #soda-game {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(145deg, #2d1b4e, #1a1a2e);
            border: 3px solid #ff6b9d;
            border-radius: 12px;
            padding: 15px;
            z-index: 100;
            text-align: center;
            box-shadow: 0 0 30px rgba(255, 107, 157, 0.4);
            min-width: 280px;
        }
        #soda-game.active { display: block; }
        #soda-game h3 {
            color: #ff6b9d;
            font-size: 12px;
            margin-bottom: 10px;
        }
        #soda-emoji {
            font-size: 32px;
            margin: 10px 0;
            letter-spacing: 5px;
        }
        .soda-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 10px;
        }
        .soda-btn {
            background: linear-gradient(135deg, #ff6b9d, #c44569);
            color: white;
            border: none;
            padding: 8px 12px;
            cursor: pointer;
            font-family: inherit;
            font-size: 9px;
            border-radius: 6px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .soda-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 10px rgba(255, 107, 157, 0.6);
        }
        #soda-result {
            margin-top: 10px;
            font-size: 10px;
            min-height: 20px;
        }
        .soda-vendor {
            animation: vendorBob 1s ease-in-out infinite;
        }
        @keyframes vendorBob {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-2px); }
        }
        #soda-score {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0,0,0,0.7);
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 10px;
            color: #ff6b9d;
        }
        #food-game {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(145deg, #4a2c1a, #2d1b0e);
            border: 3px solid #ffa726;
            border-radius: 12px;
            padding: 15px;
            z-index: 100;
            text-align: center;
            box-shadow: 0 0 30px rgba(255, 167, 38, 0.4);
            min-width: 280px;
        }
        #food-game.active { display: block; }
        #snake-game {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(145deg, #0a0a0a, #1a1a2e);
            border: 3px solid #00ff41;
            border-radius: 12px;
            padding: 15px;
            z-index: 100;
            text-align: center;
            box-shadow: 0 0 30px rgba(0, 255, 65, 0.4);
            min-width: 280px;
        }
        #snake-game.active { display: block; }
        #snake-game h3 {
            color: #00ff41;
            font-size: 12px;
            margin-bottom: 10px;
            text-shadow: 0 0 10px #00ff41;
        }
        #snakeCanvas {
            border: 2px solid #00ff41;
            background: #000;
            display: block;
            margin: 10px auto;
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.3);
        }
        #snake-score {
            color: #00ff41;
            font-size: 10px;
            margin: 5px 0;
        }
        .snake-btn {
            background: linear-gradient(135deg, #00ff41, #00aa2a);
            color: #000;
            border: none;
            padding: 8px 12px;
            cursor: pointer;
            font-family: inherit;
            font-size: 9px;
            border-radius: 6px;
            margin-top: 10px;
        }
        .snake-btn:hover {
            box-shadow: 0 0 15px rgba(0, 255, 65, 0.8);
        }
        .arcade-cabinet {
            animation: arcadeGlow 1.5s ease-in-out infinite alternate;
        }
        @keyframes arcadeGlow {
            0% { filter: brightness(1); }
            100% { filter: brightness(1.3); }
        }
        #food-game h3 {
            color: #ffa726;
            font-size: 12px;
            margin-bottom: 10px;
        }
        #food-emoji {
            font-size: 32px;
            margin: 10px 0;
            letter-spacing: 5px;
        }
        .food-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 10px;
        }
        .food-btn {
            background: linear-gradient(135deg, #ffa726, #f57c00);
            color: white;
            border: none;
            padding: 8px 12px;
            cursor: pointer;
            font-family: inherit;
            font-size: 9px;
            border-radius: 6px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .food-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 10px rgba(255, 167, 38, 0.6);
        }
        #food-result {
            margin-top: 10px;
            font-size: 10px;
            min-height: 20px;
        }
        .chef-npc {
            animation: chefBob 0.8s ease-in-out infinite;
        }
        @keyframes chefBob {
            0%, 100% { transform: translateY(0) rotate(-2deg); }
            50% { transform: translateY(-2px) rotate(2deg); }
        }
    </style>
</head>
<body>
<div id="tutorial-banner">
<button id="close-tutorial" onclick="this.parentElement.style.display='none'">‚úï</button>
<h4>üéÆ TWITCH PLAYS EXPERIMENT üéÆ</h4>
<p>Welcome! This page is <span class="highlight">collaboratively built by chat</span>. Send messages to add features!<br/>
        ü§ñ AI evolves the site based on community requests ‚Ä¢ üó≥Ô∏è Popular ideas get priority ‚Ä¢ ‚ö° Watch chaos unfold live!</p>
</div>
<div id="game-container">
<canvas height="300" id="gameCanvas" width="400"></canvas>
<div id="ui">
<div>üéÆ Monsters: <span id="caught">0</span>/6</div>
<div>ü•§ Sodas: <span id="sodas-won">0</span></div>
<div>üçΩÔ∏è Dishes: <span id="food-won">0</span></div>
<div>üïπÔ∏è Snake HI: <span id="snake-hi">0</span></div>
</div>
<div id="soda-score">üè™ Vendor | üë®‚Äçüç≥ Chef</div>
<div id="soda-game">
<h3>ü•§ SODA VENDOR ü•§</h3>
<div>Guess the soda from emojis!</div>
<div id="soda-emoji">üî¥‚ö´üç¨</div>
<div class="soda-options" id="soda-options"></div>
<div id="soda-result"></div>
<button class="soda-btn" onclick="closeSodaGame()" style="margin-top:10px;background:#666;">‚ùå Leave</button>
</div>
<div id="food-game">
<h3>üë®‚Äçüç≥ CHEF'S KITCHEN üë®‚Äçüç≥</h3>
<div>Guess the dish from emojis!</div>
<div id="food-emoji">üçùüçÖüßÄ</div>
<div class="food-options" id="food-options"></div>
<div id="food-result"></div>
<button class="food-btn" onclick="closeFoodGame()" style="margin-top:10px;background:#666;">‚ùå Leave</button>
</div>
<div id="snake-game">
<h3>üïπÔ∏è SNAKE ARCADE üïπÔ∏è</h3>
<div style="font-size:9px;color:#00ff41;">AI is playing autonomously!</div>
<canvas height="150" id="snakeCanvas" width="200"></canvas>
<div id="snake-score">Score: 0 | High Score: 0</div>
<div id="snake-status" style="font-size:8px;color:#888;">ü§ñ AI: Hunting food...</div>
<button class="snake-btn" onclick="closeSnakeGame()">‚ùå Leave Arcade</button>
</div>
<div id="battle-ui">
<div class="monster-display">
<div class="monster-card">
<div id="player-monster">üî• Flamby</div>
<div class="hp-bar"><div class="hp-fill" id="player-hp" style="width:100%"></div></div>
<div>HP: <span id="player-hp-text">30/30</span></div>
</div>
<div class="monster-card">
<div id="wild-monster">???</div>
<div class="hp-bar"><div class="hp-fill" id="wild-hp" style="width:100%"></div></div>
<div>HP: <span id="wild-hp-text">??</span></div>
</div>
</div>
<div id="message">A wild monster appeared!</div>
<div class="battle-options">
<button class="battle-btn" onclick="attack()">‚öîÔ∏è FIGHT</button>
<button class="battle-btn" onclick="catchMonster()">üéØ CATCH</button>
<button class="battle-btn" onclick="runAway()">üèÉ RUN</button>
</div>
</div>
</div>
<div id="controls">ü§ñ AUTO-PILOT ACTIVE | Press SPACE to toggle manual mode</div>
<div id="ai-status" style="margin-top:5px;font-size:8px;color:#bf94ff;">AI: Exploring...</div>
<script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        const TILE = 20;
        const COLS = canvas.width / TILE;
        const ROWS = canvas.height / TILE;
        
        const monsters = [
            { name: 'Flamby', emoji: 'üî•', hp: 30, atk: 8 },
            { name: 'Aqualing', emoji: 'üíß', hp: 35, atk: 6 },
            { name: 'Leafeon', emoji: 'üåø', hp: 28, atk: 7 },
            { name: 'Sparky', emoji: '‚ö°', hp: 25, atk: 10 },
            { name: 'Ghosty', emoji: 'üëª', hp: 22, atk: 9 },
            { name: 'Rocko', emoji: 'ü™®', hp: 40, atk: 5 },
            { name: 'Starbit', emoji: '‚≠ê', hp: 26, atk: 8 },
            { name: 'Moonix', emoji: 'üåô', hp: 32, atk: 7 }
        ];
        
        let player = { x: 10, y: 7, monster: {...monsters[0], maxHp: 30} };
        let caughtMonsters = [player.monster];
        let wildMonster = null;
        let inBattle = false;
        
        // Generate map with grass patches
        let map = [];
        for (let y = 0; y < ROWS; y++) {
            map[y] = [];
            for (let x = 0; x < COLS; x++) {
                // Create grass patches
                if (Math.random() < 0.3 && !(x === 10 && y === 7)) {
                    map[y][x] = 'grass';
                } else {
                    map[y][x] = 'ground';
                }
            }
        }
        
        // Add some trees as obstacles
        for (let i = 0; i < 8; i++) {
            let tx = Math.floor(Math.random() * COLS);
            let ty = Math.floor(Math.random() * ROWS);
            if (!(tx === 10 && ty === 7)) map[ty][tx] = 'tree';
        }
        
        // Add Soda Vendor!
        let vendorX = 5, vendorY = 5;
        map[vendorY][vendorX] = 'vendor';
        
        // Add Chef NPC!
        let chefX = 15, chefY = 10;
        map[chefY][chefX] = 'chef';
        
        // Add Snake Arcade Cabinet!
        let arcadeX = 18, arcadeY = 3;
        map[arcadeY][arcadeX] = 'arcade';
        
        // Soda game data
        const sodaQuizzes = [
            { emoji: 'üî¥‚ö´üç¨', answer: 'Coca-Cola', options: ['Coca-Cola', 'Pepsi', 'Dr Pepper', 'Fanta'] },
            { emoji: 'üîµüåäüí´', answer: 'Pepsi', options: ['Sprite', 'Pepsi', '7-Up', 'Mountain Dew'] },
            { emoji: 'üçãüíö‚ú®', answer: 'Sprite', options: ['Sprite', 'Sierra Mist', 'Ginger Ale', 'Tonic'] },
            { emoji: 'üçä‚òÄÔ∏èüéâ', answer: 'Fanta', options: ['Crush', 'Fanta', 'Sunkist', 'Mirinda'] },
            { emoji: '‚õ∞Ô∏èüå≤üíö', answer: 'Mountain Dew', options: ['Sprite', 'Mello Yello', 'Mountain Dew', 'Surge'] },
            { emoji: 'üë®‚Äç‚öïÔ∏èüå∂Ô∏èüçí', answer: 'Dr Pepper', options: ['Dr Pepper', 'Mr Pibb', 'Cherry Coke', 'Root Beer'] },
            { emoji: 'üçíüî¥üíã', answer: 'Cherry Coke', options: ['Dr Pepper', 'Cherry Coke', 'Big Red', 'Cheerwine'] },
            { emoji: 'üå≥üç∫üåø', answer: 'Root Beer', options: ['Ginger Ale', 'Root Beer', 'Cream Soda', 'Birch Beer'] },
            { emoji: 'üêÇ‚ö°üí™', answer: 'Red Bull', options: ['Monster', 'Red Bull', 'Rockstar', 'Nos'] },
            { emoji: 'üëπüíö‚ö°', answer: 'Monster', options: ['Red Bull', 'Monster', 'Full Throttle', 'Amp'] }
        ];
        let currentQuiz = null;
        let sodasWon = 0;
        let inSodaGame = false;
        
        // Food quiz data
        const foodQuizzes = [
            { emoji: 'üçùüçÖüßÄ', answer: 'Spaghetti', options: ['Spaghetti', 'Lasagna', 'Ravioli', 'Penne'] },
            { emoji: 'üçîü•¨üçü', answer: 'Burger', options: ['Burger', 'Sandwich', 'Hot Dog', 'Taco'] },
            { emoji: 'üçïüßÄüçÖ', answer: 'Pizza', options: ['Calzone', 'Pizza', 'Flatbread', 'Focaccia'] },
            { emoji: 'üç£üêüüçö', answer: 'Sushi', options: ['Sushi', 'Sashimi', 'Poke Bowl', 'Onigiri'] },
            { emoji: 'üåÆü•©üå∂Ô∏è', answer: 'Taco', options: ['Burrito', 'Taco', 'Quesadilla', 'Enchilada'] },
            { emoji: 'ü•óü•íüçÖ', answer: 'Salad', options: ['Salad', 'Coleslaw', 'Gazpacho', 'Bruschetta'] },
            { emoji: 'üçúü•¢ü•ö', answer: 'Ramen', options: ['Pho', 'Ramen', 'Udon', 'Soba'] },
            { emoji: 'ü•ûüçØüßà', answer: 'Pancakes', options: ['Waffles', 'Pancakes', 'French Toast', 'Crepes'] },
            { emoji: 'üç¶üç´üçí', answer: 'Sundae', options: ['Milkshake', 'Sundae', 'Gelato', 'Parfait'] },
            { emoji: 'üåØü•ëüçó', answer: 'Burrito', options: ['Wrap', 'Burrito', 'Fajita', 'Chimichanga'] },
            { emoji: 'üçõüçöüå∂Ô∏è', answer: 'Curry', options: ['Curry', 'Biryani', 'Tikka', 'Korma'] },
            { emoji: 'ü•êüßà‚òï', answer: 'Croissant', options: ['Bagel', 'Croissant', 'Danish', 'Brioche'] }
        ];
        let currentFoodQuiz = null;
        let foodWon = 0;
        let inFoodGame = false;
        let inSnakeGame = false;
        let snakeScore = 0;
        let snakeHighScore = 0;
        let snakeInterval = null;
        
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw map
            for (let y = 0; y < ROWS; y++) {
                for (let x = 0; x < COLS; x++) {
                    if (map[y][x] === 'grass') {
                        ctx.fillStyle = '#228B22';
                        ctx.fillRect(x * TILE, y * TILE, TILE, TILE);
                        ctx.fillStyle = '#32CD32';
                        ctx.font = '12px Arial';
                        ctx.fillText('~', x * TILE + 6, y * TILE + 14);
                    } else if (map[y][x] === 'tree') {
                        ctx.fillStyle = '#3d8b40';
                        ctx.fillRect(x * TILE, y * TILE, TILE, TILE);
                        ctx.font = '16px Arial';
                        ctx.fillText('üå≤', x * TILE + 2, y * TILE + 16);
                    } else if (map[y][x] === 'vendor') {
                        ctx.fillStyle = '#5a9b5c';
                        ctx.fillRect(x * TILE, y * TILE, TILE, TILE);
                        ctx.font = '16px Arial';
                        ctx.fillText('üè™', x * TILE + 2, y * TILE + 16);
                    } else if (map[y][x] === 'chef') {
                        ctx.fillStyle = '#5a9b5c';
                        ctx.fillRect(x * TILE, y * TILE, TILE, TILE);
                        ctx.font = '16px Arial';
                        ctx.fillText('üë®‚Äçüç≥', x * TILE + 2, y * TILE + 16);
                    } else if (map[y][x] === 'arcade') {
                        ctx.fillStyle = '#2a2a4a';
                        ctx.fillRect(x * TILE, y * TILE, TILE, TILE);
                        ctx.font = '16px Arial';
                        ctx.fillText('üïπÔ∏è', x * TILE + 2, y * TILE + 16);
                    } else {
                        ctx.fillStyle = '#5a9b5c';
                        ctx.fillRect(x * TILE, y * TILE, TILE, TILE);
                    }
                }
            }
            
            // Draw player
            ctx.font = '18px Arial';
            ctx.fillText('üßë', player.x * TILE + 1, player.y * TILE + 17);
        }
        
        function move(dx, dy) {
            if (inBattle) return;
            let nx = player.x + dx;
            let ny = player.y + dy;
            if (nx >= 0 && nx < COLS && ny >= 0 && ny < ROWS && map[ny][nx] !== 'tree' && map[ny][nx] !== 'vendor' && map[ny][nx] !== 'chef' && map[ny][nx] !== 'arcade') {
                player.x = nx;
                player.y = ny;
                draw();
                
                // Check for wild encounter in grass
                if (map[ny][nx] === 'grass' && Math.random() < 0.15) {
                    startBattle();
                }
                
                // Check if near vendor
                if (Math.abs(nx - vendorX) <= 1 && Math.abs(ny - vendorY) <= 1 && !inSodaGame && !inBattle && !inFoodGame) {
                    openSodaGame();
                }
                
                // Check if near chef
                if (Math.abs(nx - chefX) <= 1 && Math.abs(ny - chefY) <= 1 && !inFoodGame && !inBattle && !inSodaGame && !inSnakeGame) {
                    openFoodGame();
                }
                
                // Check if near arcade
                if (Math.abs(nx - arcadeX) <= 1 && Math.abs(ny - arcadeY) <= 1 && !inSnakeGame && !inBattle && !inSodaGame && !inFoodGame) {
                    openSnakeGame();
                }
            }
        }
        
        function startBattle() {
            inBattle = true;
            wildMonster = {...monsters[Math.floor(Math.random() * monsters.length)]};
            wildMonster.maxHp = wildMonster.hp;
            
            document.getElementById('battle-ui').classList.add('active');
            document.getElementById('wild-monster').textContent = wildMonster.emoji + ' ' + wildMonster.name;
            updateBattleUI();
            setMessage('A wild ' + wildMonster.name + ' appeared!');
        }
        
        function updateBattleUI() {
            document.getElementById('player-hp').style.width = (player.monster.hp / player.monster.maxHp * 100) + '%';
            document.getElementById('player-hp-text').textContent = player.monster.hp + '/' + player.monster.maxHp;
            document.getElementById('wild-hp').style.width = (wildMonster.hp / wildMonster.maxHp * 100) + '%';
            document.getElementById('wild-hp-text').textContent = wildMonster.hp + '/' + wildMonster.maxHp;
        }
        
        function setMessage(msg) {
            document.getElementById('message').textContent = msg;
        }
        
        function attack() {
            if (!inBattle) return;
            let dmg = player.monster.atk + Math.floor(Math.random() * 5);
            wildMonster.hp = Math.max(0, wildMonster.hp - dmg);
            setMessage('Dealt ' + dmg + ' damage!');
            updateBattleUI();
            
            if (wildMonster.hp <= 0) {
                setTimeout(() => {
                    setMessage(wildMonster.name + ' fainted!');
                    setTimeout(endBattle, 1000);
                }, 500);
                return;
            }
            
            // Enemy attacks back
            setTimeout(() => {
                let eDmg = wildMonster.atk + Math.floor(Math.random() * 4);
                player.monster.hp = Math.max(0, player.monster.hp - eDmg);
                setMessage(wildMonster.name + ' dealt ' + eDmg + ' damage!');
                updateBattleUI();
                
                if (player.monster.hp <= 0) {
                    setTimeout(() => {
                        player.monster.hp = player.monster.maxHp;
                        setMessage('You blacked out... Healed up!');
                        setTimeout(endBattle, 1000);
                    }, 500);
                }
            }, 800);
        }
        
        function catchMonster() {
            if (!inBattle || caughtMonsters.length >= 6) return;
            let chance = (1 - wildMonster.hp / wildMonster.maxHp) * 0.5 + 0.2;
            if (Math.random() < chance) {
                caughtMonsters.push({...wildMonster});
                document.getElementById('caught').textContent = caughtMonsters.length;
                setMessage('Caught ' + wildMonster.name + '! üéâ');
                setTimeout(endBattle, 1200);
            } else {
                setMessage('Oh no! ' + wildMonster.name + ' broke free!');
                setTimeout(() => {
                    let eDmg = wildMonster.atk + Math.floor(Math.random() * 4);
                    player.monster.hp = Math.max(0, player.monster.hp - eDmg);
                    setMessage(wildMonster.name + ' attacked! -' + eDmg + ' HP');
                    updateBattleUI();
                }, 800);
            }
        }
        
        function runAway() {
            if (!inBattle) return;
            if (Math.random() < 0.7) {
                setMessage('Got away safely!');
                setTimeout(endBattle, 800);
            } else {
                setMessage('Can\'t escape!');
            }
        }
        
        function endBattle() {
            inBattle = false;
            wildMonster = null;
            document.getElementById('battle-ui').classList.remove('active');
        }
        
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowUp' || e.key === 'w' || e.key === 'W') move(0, -1);
            if (e.key === 'ArrowDown' || e.key === 's' || e.key === 'S') move(0, 1);
            if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') move(-1, 0);
            if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') move(1, 0);
        });
        
        draw();
        
        // SODA GAME FUNCTIONS
        function openSodaGame() {
            inSodaGame = true;
            currentQuiz = sodaQuizzes[Math.floor(Math.random() * sodaQuizzes.length)];
            document.getElementById('soda-emoji').textContent = currentQuiz.emoji;
            
            const optionsDiv = document.getElementById('soda-options');
            optionsDiv.innerHTML = '';
            
            // Shuffle options
            let shuffled = [...currentQuiz.options].sort(() => Math.random() - 0.5);
            shuffled.forEach(opt => {
                let btn = document.createElement('button');
                btn.className = 'soda-btn';
                btn.textContent = opt;
                btn.onclick = () => guessSoda(opt);
                optionsDiv.appendChild(btn);
            });
            
            document.getElementById('soda-result').textContent = '';
            document.getElementById('soda-game').classList.add('active');
        }
        
        function guessSoda(guess) {
            const resultDiv = document.getElementById('soda-result');
            if (guess === currentQuiz.answer) {
                sodasWon++;
                document.getElementById('sodas-won').textContent = sodasWon;
                resultDiv.innerHTML = 'üéâ CORRECT! +1 Soda! Your monster healed!';
                resultDiv.style.color = '#4ade80';
                player.monster.hp = Math.min(player.monster.maxHp, player.monster.hp + 10);
            } else {
                resultDiv.innerHTML = '‚ùå Wrong! It was ' + currentQuiz.answer;
                resultDiv.style.color = '#ff6b6b';
            }
            
            setTimeout(() => {
                // Load new quiz
                currentQuiz = sodaQuizzes[Math.floor(Math.random() * sodaQuizzes.length)];
                document.getElementById('soda-emoji').textContent = currentQuiz.emoji;
                const optionsDiv = document.getElementById('soda-options');
                optionsDiv.innerHTML = '';
                let shuffled = [...currentQuiz.options].sort(() => Math.random() - 0.5);
                shuffled.forEach(opt => {
                    let btn = document.createElement('button');
                    btn.className = 'soda-btn';
                    btn.textContent = opt;
                    btn.onclick = () => guessSoda(opt);
                    optionsDiv.appendChild(btn);
                });
                resultDiv.textContent = '';
            }, 1500);
        }
        
        function closeSodaGame() {
            inSodaGame = false;
            document.getElementById('soda-game').classList.remove('active');
        }
        
        // FOOD GAME FUNCTIONS
        function openFoodGame() {
            inFoodGame = true;
            currentFoodQuiz = foodQuizzes[Math.floor(Math.random() * foodQuizzes.length)];
            document.getElementById('food-emoji').textContent = currentFoodQuiz.emoji;
            
            const optionsDiv = document.getElementById('food-options');
            optionsDiv.innerHTML = '';
            
            let shuffled = [...currentFoodQuiz.options].sort(() => Math.random() - 0.5);
            shuffled.forEach(opt => {
                let btn = document.createElement('button');
                btn.className = 'food-btn';
                btn.textContent = opt;
                btn.onclick = () => guessFood(opt);
                optionsDiv.appendChild(btn);
            });
            
            document.getElementById('food-result').textContent = '';
            document.getElementById('food-game').classList.add('active');
        }
        
        function guessFood(guess) {
            const resultDiv = document.getElementById('food-result');
            if (guess === currentFoodQuiz.answer) {
                foodWon++;
                document.getElementById('food-won').textContent = foodWon;
                resultDiv.innerHTML = 'üéâ DELICIOUS! +1 Dish! ATK boosted!';
                resultDiv.style.color = '#4ade80';
                player.monster.atk += 1;
            } else {
                resultDiv.innerHTML = '‚ùå Nope! It was ' + currentFoodQuiz.answer;
                resultDiv.style.color = '#ff6b6b';
            }
            
            setTimeout(() => {
                currentFoodQuiz = foodQuizzes[Math.floor(Math.random() * foodQuizzes.length)];
                document.getElementById('food-emoji').textContent = currentFoodQuiz.emoji;
                const optionsDiv = document.getElementById('food-options');
                optionsDiv.innerHTML = '';
                let shuffled = [...currentFoodQuiz.options].sort(() => Math.random() - 0.5);
                shuffled.forEach(opt => {
                    let btn = document.createElement('button');
                    btn.className = 'food-btn';
                    btn.textContent = opt;
                    btn.onclick = () => guessFood(opt);
                    optionsDiv.appendChild(btn);
                });
                resultDiv.textContent = '';
            }, 1500);
        }
        
        function closeFoodGame() {
            inFoodGame = false;
            document.getElementById('food-game').classList.remove('active');
        }
        
        // SNAKE GAME FUNCTIONS
        function openSnakeGame() {
            inSnakeGame = true;
            document.getElementById('snake-game').classList.add('active');
            startSnakeAI();
        }
        
        function closeSnakeGame() {
            inSnakeGame = false;
            document.getElementById('snake-game').classList.remove('active');
            if (snakeInterval) clearInterval(snakeInterval);
        }
        
        function startSnakeAI() {
            const sCanvas = document.getElementById('snakeCanvas');
            const sCtx = sCanvas.getContext('2d');
            const gridSize = 10;
            const cols = sCanvas.width / gridSize;
            const rows = sCanvas.height / gridSize;
            
            let snake = [{x: 10, y: 7}, {x: 9, y: 7}, {x: 8, y: 7}];
            let food = {x: 15, y: 7};
            let direction = {x: 1, y: 0};
            snakeScore = 0;
            
            function spawnFood() {
                food = {
                    x: Math.floor(Math.random() * cols),
                    y: Math.floor(Math.random() * rows)
                };
                // Don't spawn on snake
                while (snake.some(s => s.x === food.x && s.y === food.y)) {
                    food = {
                        x: Math.floor(Math.random() * cols),
                        y: Math.floor(Math.random() * rows)
                    };
                }
            }
            
            function aiDecide() {
                const head = snake[0];
                let bestDir = direction;
                let bestDist = Infinity;
                
                const dirs = [{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1}];
                
                for (let d of dirs) {
                    // Don't reverse
                    if (d.x === -direction.x && d.y === -direction.y) continue;
                    
                    let nx = head.x + d.x;
                    let ny = head.y + d.y;
                    
                    // Check walls
                    if (nx < 0 || nx >= cols || ny < 0 || ny >= rows) continue;
                    
                    // Check self collision
                    if (snake.some(s => s.x === nx && s.y === ny)) continue;
                    
                    let dist = Math.abs(nx - food.x) + Math.abs(ny - food.y);
                    if (dist < bestDist) {
                        bestDist = dist;
                        bestDir = d;
                    }
                }
                
                direction = bestDir;
                document.getElementById('snake-status').textContent = 'ü§ñ AI: ' + (bestDist < 3 ? 'Almost there!' : 'Hunting food...');
            }
            
            function gameLoop() {
                aiDecide();
                
                const head = {x: snake[0].x + direction.x, y: snake[0].y + direction.y};
                
                // Check collision
                if (head.x < 0 || head.x >= cols || head.y < 0 || head.y >= rows ||
                    snake.some(s => s.x === head.x && s.y === head.y)) {
                    // Game over - restart
                    if (snakeScore > snakeHighScore) {
                        snakeHighScore = snakeScore;
                        document.getElementById('snake-hi').textContent = snakeHighScore;
                    }
                    snake = [{x: 10, y: 7}, {x: 9, y: 7}, {x: 8, y: 7}];
                    direction = {x: 1, y: 0};
                    snakeScore = 0;
                    spawnFood();
                    document.getElementById('snake-status').textContent = 'ü§ñ AI: Restarting...';
                    return;
                }
                
                snake.unshift(head);
                
                // Check food
                if (head.x === food.x && head.y === food.y) {
                    snakeScore += 10;
                    spawnFood();
                    document.getElementById('snake-status').textContent = 'ü§ñ AI: Yum! +10';
                } else {
                    snake.pop();
                }
                
                // Draw
                sCtx.fillStyle = '#000';
                sCtx.fillRect(0, 0, sCanvas.width, sCanvas.height);
                
                // Draw snake
                snake.forEach((seg, i) => {
                    sCtx.fillStyle = i === 0 ? '#00ff41' : '#00aa2a';
                    sCtx.fillRect(seg.x * gridSize, seg.y * gridSize, gridSize - 1, gridSize - 1);
                });
                
                // Draw food
                sCtx.fillStyle = '#ff0040';
                sCtx.fillRect(food.x * gridSize, food.y * gridSize, gridSize - 1, gridSize - 1);
                
                document.getElementById('snake-score').textContent = 'Score: ' + snakeScore + ' | High Score: ' + snakeHighScore;
            }
            
            if (snakeInterval) clearInterval(snakeInterval);
            snakeInterval = setInterval(gameLoop, 100);
        }
        
        // AI AUTOPILOT SYSTEM
        let autoMode = true;
        let aiThinkTimer = null;
        let aiActionQueue = [];
        
        function getRandomDirection() {
            const dirs = [[0,-1],[0,1],[-1,0],[1,0]];
            return dirs[Math.floor(Math.random() * dirs.length)];
        }
        
        function findNearestGrass() {
            let nearest = null;
            let minDist = Infinity;
            for (let y = 0; y < ROWS; y++) {
                for (let x = 0; x < COLS; x++) {
                    if (map[y][x] === 'grass') {
                        let dist = Math.abs(x - player.x) + Math.abs(y - player.y);
                        if (dist < minDist && dist > 0) {
                            minDist = dist;
                            nearest = {x, y};
                        }
                    }
                }
            }
            return nearest;
        }
        
        function aiMove() {
            if (!autoMode || inBattle || inSodaGame) return;
            
            let grass = findNearestGrass();
            let dx = 0, dy = 0;
            
            if (grass && Math.random() < 0.7) {
                // Move toward grass
                if (grass.x > player.x) dx = 1;
                else if (grass.x < player.x) dx = -1;
                else if (grass.y > player.y) dy = 1;
                else if (grass.y < player.y) dy = -1;
                updateAIStatus('üéØ Hunting monsters...');
            } else {
                // Random exploration
                let dir = getRandomDirection();
                dx = dir[0];
                dy = dir[1];
                updateAIStatus('üîç Exploring...');
            }
            
            // Check if move is valid, otherwise try another direction
            let nx = player.x + dx;
            let ny = player.y + dy;
            if (nx < 0 || nx >= COLS || ny < 0 || ny >= ROWS || map[ny][nx] === 'tree') {
                let dir = getRandomDirection();
                dx = dir[0];
                dy = dir[1];
            }
            
            move(dx, dy);
        }
        
        function aiBattle() {
            if (!autoMode || !inBattle) return;
            
            setTimeout(() => {
                if (!inBattle) return;
                
                let hpPercent = wildMonster.hp / wildMonster.maxHp;
                let alreadyCaught = caughtMonsters.some(m => m.name === wildMonster.name);
                
                if (caughtMonsters.length < 6 && !alreadyCaught && hpPercent < 0.5) {
                    updateAIStatus('üéØ Attempting catch!');
                    catchMonster();
                } else if (caughtMonsters.length < 6 && !alreadyCaught && hpPercent >= 0.5) {
                    updateAIStatus('‚öîÔ∏è Weakening target...');
                    attack();
                } else {
                    updateAIStatus('‚öîÔ∏è Fighting!');
                    attack();
                }
                
                // Continue battle AI
                setTimeout(() => {
                    if (inBattle) aiBattle();
                }, 1500);
            }, 800);
        }
        
        function updateAIStatus(text) {
            document.getElementById('ai-status').textContent = 'AI: ' + text;
        }
        
        // Override startBattle to trigger AI
        const originalStartBattle = startBattle;
        startBattle = function() {
            originalStartBattle();
            if (autoMode) {
                updateAIStatus('‚öîÔ∏è Battle started!');
                aiBattle();
            }
        };
        
        // Override endBattle to resume exploration
        const originalEndBattle = endBattle;
        endBattle = function() {
            originalEndBattle();
            if (autoMode) {
                updateAIStatus('‚úì Battle complete!');
                setTimeout(() => updateAIStatus('üîç Exploring...'), 1000);
            }
        };
        
        // Toggle auto mode with SPACE
        document.addEventListener('keydown', (e) => {
            if (e.key === ' ') {
                autoMode = !autoMode;
                document.getElementById('controls').textContent = autoMode 
                    ? 'ü§ñ AUTO-PILOT ACTIVE | Press SPACE to toggle manual mode'
                    : 'üéÆ MANUAL MODE | WASD/Arrows to move | SPACE for auto';
                updateAIStatus(autoMode ? 'Resuming...' : 'Manual control');
            }
        });
        
        // AI loop
        setInterval(() => {
            if (autoMode && !inBattle && !inFoodGame && !inSnakeGame) {
                aiMove();
            }
        }, 400);
    </script>
</body>
</html>